/**
 * @fileoverview Firestore Security Rules for the Hagaaty AI Blog.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles and campaigns,
 * and a public-read, admin-write model for articles, categories, and tags.
 * It includes specific logic for user point and balance management.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided user ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is an admin.
     * Admins are identified by a 'role' field in their user profile.
     */
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    /**
     * @description Checks if the authenticated user is the owner of an existing document.
     */
    function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
    }
    
    /**
     * @description Validates the fields that a user is allowed to update on their own profile.
     * Prevents users from illegitimately changing their role, referral code, or earnings.
     */
    function hasAllowedUserUpdates() {
        let incoming = request.resource.data;
        let existing = resource.data;
        
        // Prevent changing immutable or admin-controlled fields
        return incoming.id == existing.id
            && incoming.email == existing.email
            && incoming.role == existing.role
            && incoming.createdAt == existing.createdAt
            && incoming.referralCode == existing.referralCode
            && incoming.referralEarnings == existing.referralEarnings
            && incoming.referredBy == existing.referredBy;
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      
      // Allow creation if the user is creating their own document.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      
      // Allow updates under specific, controlled conditions.
      allow update: if isOwner(userId) && hasAllowedUserUpdates() && (
        // Case 1: Triggering the marketing agent.
        (
          request.resource.data.points == resource.data.points + 10 &&
          request.resource.data.balance == resource.data.balance &&
          request.resource.data.lastMarketingTriggerAt == request.time &&
          (resource.data.lastMarketingTriggerAt == null || request.time > resource.data.lastMarketingTriggerAt + duration.time(24, 0, 0, 0))
        ) ||
        // Case 2: Cashing in points for a reward.
        (
          request.resource.data.points == resource.data.points + 10 - 100 &&
          request.resource.data.balance == resource.data.balance + 5 &&
          (resource.data.points + 10) >= 100
        ) ||
        // Case 3: Debiting balance for creating an ad campaign.
        (
           request.resource.data.balance == resource.data.balance - 2 &&
           request.resource.data.points == resource.data.points &&
           request.resource.data.lastMarketingTriggerAt == resource.data.lastMarketingTriggerAt
        ) ||
        // Case 4: General profile updates (like displayName) that don't affect protected fields.
        (
            request.resource.data.balance == resource.data.balance &&
            request.resource.data.points == resource.data.points &&
            request.resource.data.lastMarketingTriggerAt == resource.data.lastMarketingTriggerAt
        )
      );

      allow delete: if isAdmin();

      /**
       * @description Rules for user's ad campaigns.
       * Users can manage their own campaigns. Admins can view all campaigns
       * via collection group queries.
       */
      match /campaigns/{campaignId} {
          allow read, write: if isOwner(userId);
      }
    }
    
    // Admins can read all campaigns for the main dashboard view.
    match /{path=**}/campaigns/{campaignId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
    }


    /**
     * @description Rules for articles. Publicly readable, but only admins
     * can create, update, or delete.
     */
    match /posts/{postId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Rules for categories. Public read, admin write.
     */
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Rules for tags. Public read, admin write.
     */
    match /tags/{tagId} {
      allow read: if true;
      allow write: if isAdmin();
    }

     /**
      * @description Rules for user queries from the smart assistant.
      * Write-only for authenticated users to protect privacy.
      */
    match /queries/{queryId} {
      allow read, update, delete: if false;
      allow create: if isSignedIn();
    }
  }
}
